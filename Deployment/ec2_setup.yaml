---
- name: Setup Web Server with Git, MongoDB, Docker, and Gemini API
  hosts: web_servers
  become: true
  tasks:

    - name: Update all packages
      yum:
        name: '*'
        state: latest

    - name: Install Git
      yum:
        name: git
        state: present

    - name: Clone MemeGenerator repository
      git:
        repo: 'https://github.com/roee4647/MemeGenerator'
        dest: /home/ec2-user/App/MemeGenerator
        update: yes

    - name: Set Gemini API Key in environment
      shell: |
        echo "export GEMINI_API_KEY='{{ lookup('env', 'HOST_GEMINI_API_KEY') }}'" >> /home/ec2-user/.bash_profile
        source /home/ec2-user/.bash_profile
      become_user: ec2-user

    - name: Add MongoDB repo
      copy:
        dest: /etc/yum.repos.d/mongodb-org-8.0.repo
        content: |
          [mongodb-org-8.0]
          name=MongoDB Repository
          baseurl=https://repo.mongodb.org/yum/amazon/2023/mongodb-org/8.0/x86_64/
          gpgcheck=1
          enabled=1
          gpgkey=https://pgp.mongodb.com/server-8.0.asc

    - name: Install MongoDB
      yum:
        name: mongodb-org
        state: present

    - name: Configure MongoDB to bind to 0.0.0.0
      lineinfile:
        path: /etc/mongod.conf
        regexp: '^bindIp:.*'
        line: 'bindIp: 0.0.0.0'
      
    - name: Start MongoDB service
      service:
        name: mongod
        state: started
        enabled: yes

    - name: Install Docker
      yum:
        name: docker
        state: present

    - name: Start Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Build Gemini API Docker image
      docker_image:
        path: /home/ec2-user/App/MemeGenerator/GeminiApiApp
        name: gemini-api-app
        tag: latest

    - name: Run Gemini API Docker container
      docker_container:
        name: gemini-api-app
        image: gemini-api-app:latest
        state: started
        restart_policy: always
        env:
          GEMINI_API_KEY: "{{ lookup('env', 'HOST_GEMINI_API_KEY') }}"
        published_ports:
          - "5000:5000"

    - name: Build MongoDB Memes Docker image
      docker_image:
        path: /home/ec2-user/App/MemeGenerator/MongoDbMemes
        name: meme-mongo-app
        tag: latest

    - name: Run MongoDB Memes Docker container
      docker_container:
        name: meme-mongo-app
        image: meme-mongo-app:latest
        state: started
        restart_policy: always
        published_ports:
          - "5001:5001"
